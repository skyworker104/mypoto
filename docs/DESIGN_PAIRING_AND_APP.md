# PhotoNest - 설계서: 서버-폰 페어링 & 모바일 앱

---

## Part 1. 서버-폰 페어링 프로토콜

### 1.1 페어링 개요

```
┌─────────────┐         가정 내 Wi-Fi          ┌─────────────────┐
│  PhotoNest  │◄──────────────────────────────►│   Flutter App   │
│   Server    │   mDNS 자동 발견 + PIN 인증     │   (iPhone/AOS)  │
│  (셋탑/태블릿) │                               │                 │
└─────────────┘                                └─────────────────┘
```

**핵심 원칙**:
- 같은 Wi-Fi 네트워크 안에서 **자동 서버 발견** (수동 IP 입력 불필요)
- **6자리 PIN 코드**로 간편하고 안전한 인증
- 한번 페어링하면 **자동 재연결** (토큰 기반)

---

### 1.2 페어링 플로우 (전체)

```
[서버 - 셋탑박스/태블릿]                    [앱 - 핸드폰]

1. 서버 시작 시 mDNS 서비스 등록
   _photonest._tcp.local:8080

                                           2. 앱 첫 실행 → "서버 찾는 중..."
                                              mDNS로 네트워크 스캔

                                           3. 서버 발견!
                                              "PhotoNest 서버 (거실 셋탑)"
                                              → 사용자가 탭하여 선택

4. 서버: 6자리 PIN 생성 (5분 유효)
   TV 화면 또는 태블릿 화면에 표시
   ┌──────────────────┐
   │   페어링 코드     │
   │                  │
   │   4  7  2  9  1  8  │
   │                  │
   │   5분 후 만료     │
   └──────────────────┘

                                           5. 사용자가 앱에 PIN 입력
                                              [4][7][2][9][1][8] → 확인

6. PIN 검증 성공
   → 기기 등록 + JWT 토큰 발급
   → device_id, access_token,
      refresh_token 반환

                                           7. 토큰 안전하게 저장 (Secure Storage)
                                              페어링 완료!
                                              → 자동 백업 시작
```

---

### 1.3 상세 프로토콜 명세

#### Step 1: 서버 디스커버리 (mDNS/Bonjour)

| 항목 | 값 |
|------|---|
| 서비스 타입 | `_photonest._tcp.local` |
| 포트 | `8080` (설정 변경 가능) |
| TXT 레코드 | `server_id`, `server_name`, `version` |
| 프로토콜 | mDNS (Multicast DNS) - iOS Bonjour / Android NSD 호환 |

```
TXT Record 예시:
  server_id=pn_a1b2c3d4
  server_name=거실 셋탑
  version=1.0.0
  requires_setup=false
```

**폴백**: mDNS 실패 시 → 수동 IP:Port 입력 화면 제공

#### Step 2: PIN 기반 인증

| 항목 | 명세 |
|------|------|
| PIN 형식 | 숫자 6자리 (랜덤 생성) |
| 유효 시간 | 5분 (만료 후 재생성 필요) |
| 시도 제한 | 5회 실패 → 10분 잠금 |
| 표시 위치 | TV 화면 (셋탑) 또는 태블릿 화면 |
| 생성 방식 | `secrets.randbelow(900000) + 100000` |

#### Step 3: 기기 등록 & 토큰 발급

```
POST /api/v1/pair
Content-Type: application/json

요청:
{
  "pin": "472918",
  "device_name": "엄마 iPhone",
  "device_type": "ios",        // "ios" | "android"
  "device_model": "iPhone 15",
  "app_version": "1.0.0"
}

응답 (성공 - 200):
{
  "device_id": "dev_f7e8d9c0",
  "user_id": "usr_a1b2c3",
  "access_token": "eyJhbG...",      // 유효: 24시간
  "refresh_token": "eyJhbG...",     // 유효: 30일
  "server_name": "거실 셋탑",
  "server_url": "https://192.168.1.100:8080"
}

응답 (실패 - 401):
{
  "error": "invalid_pin",
  "remaining_attempts": 3,
  "message": "PIN이 올바르지 않습니다"
}
```

#### Step 4: 자동 재연결

```
이후 모든 API 호출:
Authorization: Bearer {access_token}

토큰 만료 시 자동 갱신:
POST /api/v1/auth/refresh
{
  "refresh_token": "eyJhbG...",
  "device_id": "dev_f7e8d9c0"
}
```

---

### 1.4 관리자 초기 설정 (최초 1회)

서버를 처음 시작할 때, 관리자 계정을 먼저 생성합니다.

```
[서버 첫 시작]
      │
      ▼
┌─ 초기 설정 모드 ─────────────────────────┐
│                                          │
│  TV/태블릿 화면에 QR코드 + URL 표시       │
│                                          │
│  ┌────────────────────────────┐          │
│  │  PhotoNest 초기 설정        │          │
│  │                            │          │
│  │  ▣ (QR코드)                │          │
│  │                            │          │
│  │  또는 브라우저에서 접속:     │          │
│  │  http://192.168.1.100:8080 │          │
│  └────────────────────────────┘          │
│                                          │
└──────────────────────────────────────────┘
      │
      ▼
[관리자가 브라우저 또는 앱에서 접속]
      │
      ▼
┌─ 관리자 계정 생성 ───────────────────────┐
│  닉네임: ________                        │
│  비밀번호: ________  (4자리 이상)         │
│  프로필 사진: (선택)                      │
│                                          │
│  [가족 그룹 이름]: 우리 가족              │
│                                          │
│  [ 설정 완료 ]                           │
└──────────────────────────────────────────┘
      │
      ▼
[관리자 페어링 완료 → 이후 가족 초대 가능]
```

---

### 1.5 가족 구성원 초대 플로우

관리자가 가족을 초대하는 과정:

```
[관리자 앱]                              [초대받는 가족 앱]

1. 설정 → 가족 관리 → "초대하기" 탭

2. 초대 방법 선택:
   (A) PIN 코드로 초대
   (B) QR 코드로 초대
   (C) 초대 링크 공유

── 방법 A: PIN ──────────────────────────────────
3a. 서버에 초대 PIN 생성 요청
    역할 선택: 관리자 / 일반 구성원
    서버 → 8자리 초대 PIN 생성
    (6자리 페어링PIN + 2자리 역할코드)
                                          4a. 앱 설치 → "초대 코드 입력"
                                              PIN 입력 → 계정 생성
                                              (닉네임 + 비밀번호)
                                              → 자동 페어링 완료

── 방법 B: QR 코드 ─────────────────────────────
3b. 관리자 앱에서 QR 코드 표시
    (초대 토큰 + 서버 주소 인코딩)
                                          4b. 앱 설치 → 카메라로 QR 스캔
                                              → 서버 자동 연결
                                              → 계정 생성 → 페어링 완료

── 방법 C: 링크 공유 ────────────────────────────
3c. 초대 링크 생성
    photonest://invite?token=xxx
    카카오톡/문자로 공유
                                          4c. 링크 탭 → 앱 실행
                                              → 서버 자동 연결
                                              → 계정 생성 → 페어링 완료
```

#### 초대 API

```
POST /api/v1/invite/create
Authorization: Bearer {admin_token}

요청:
{
  "role": "member",          // "admin" | "member"
  "nickname_hint": "아빠",   // 선택: 미리 닉네임 제안
  "expires_in": 86400        // 24시간 후 만료
}

응답:
{
  "invite_code": "47291835",
  "invite_token": "inv_x9y8z7...",
  "invite_url": "photonest://invite?token=inv_x9y8z7&host=192.168.1.100:8080",
  "qr_data": "photonest://invite?token=inv_x9y8z7&host=192.168.1.100:8080",
  "expires_at": "2026-02-11T15:30:00Z"
}
```

---

### 1.6 페어링 상태 관리

```
기기 상태 모델:

  paired       ←→  connected     →  disconnected
  (등록됨)         (활성 연결)        (오프라인)
     │
     ▼
  revoked
  (관리자가 해제)
```

#### 관리자 기기 관리 API

```
GET  /api/v1/devices              → 등록된 기기 목록
DELETE /api/v1/devices/{id}       → 기기 페어링 해제 (강제 로그아웃)
PATCH /api/v1/devices/{id}/rename → 기기 이름 변경
```

---

### 1.7 보안 고려사항

| 항목 | 대응 |
|------|------|
| PIN 브루트포스 | 5회 실패 → 10분 잠금, PIN 무효화 후 재생성 |
| 토큰 탈취 | Access Token 24h, Refresh Token 30일, 기기별 발급 |
| 네트워크 스니핑 | HTTPS (self-signed cert), 앱에서 인증서 핀닝 |
| 외부 네트워크 접근 차단 | 서버는 로컬 IP만 바인딩, 외부 접근은 VPN 경유만 허용 |
| 초대 코드 유출 | 1회 사용 후 즉시 무효화, 최대 24시간 유효 |

---
---

## Part 2. 모바일 앱 설계 (Google Photos 스타일)

### 2.1 앱 컨셉

> Google Photos의 **핵심 UX를 차용**하되, 기능을 **6가지 핵심**으로 간결하게 유지

```
Google Photos 기능       PhotoNest 대응          포함 여부
─────────────────────────────────────────────────────────
사진/동영상 백업         자동 백업               ✅ 핵심
타임라인 뷰             날짜별 그리드            ✅ 핵심
검색                    인물/날짜/위치 검색      ✅ 핵심
앨범                    수동 + 공유 앨범         ✅ 핵심
추억(Memories)          추억 알림 카드           ✅ 핵심
공유                    가족 공유 앨범           ✅ 핵심
Google Lens             ─                       ❌ 제외
프린트 주문             ─                       ❌ 제외
편집 도구               ─                       ❌ 제외 (Phase 1)
지도 뷰                 ─                       ❌ 후속 (Phase 3)
```

---

### 2.2 앱 네비게이션 구조

```
┌─────────────────────────────────────────────────────────┐
│                    PhotoNest App                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─ 상단 바 ──────────────────────────────────────────┐ │
│  │  [☰]  PhotoNest          [🔍 검색]  [👤 프로필]    │ │
│  └────────────────────────────────────────────────────┘ │
│                                                         │
│  ┌─ 추억 카드 (상단 가로 스크롤) ─────────────────────┐ │
│  │  [ 3년 전 오늘 ]  [ 이번 주 베스트 ]  [ 가족여행 ] │ │
│  └────────────────────────────────────────────────────┘ │
│                                                         │
│  ┌─ 메인 콘텐츠 영역 ────────────────────────────────┐ │
│  │                                                    │ │
│  │  2026년 2월 10일                                   │ │
│  │  ┌────┐ ┌────┐ ┌────┐ ┌────┐                     │ │
│  │  │    │ │    │ │    │ │    │                      │ │
│  │  │ 📷 │ │ 📷 │ │ 📷 │ │ 📷 │                      │ │
│  │  └────┘ └────┘ └────┘ └────┘                      │ │
│  │                                                    │ │
│  │  2026년 2월 9일                                    │ │
│  │  ┌────┐ ┌────┐ ┌────┐                             │ │
│  │  │    │ │    │ │    │                              │ │
│  │  │ 📷 │ │ 📷 │ │ 🎬 │  ← 동영상                   │ │
│  │  └────┘ └────┘ └────┘                              │ │
│  │                                                    │ │
│  │  (무한 스크롤)                                      │ │
│  └────────────────────────────────────────────────────┘ │
│                                                         │
│  ┌─ 하단 탭 바 ──────────────────────────────────────┐ │
│  │                                                    │ │
│  │   📷        🔍         📁        👨‍👩‍👧‍👦        📺    │ │
│  │  사진      검색       앨범      가족       TV      │ │
│  │                                                    │ │
│  └────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

---

### 2.3 탭별 상세 설계

#### Tab 1: 사진 (홈) - Google Photos 메인과 동일 구조

```
┌─ 사진 탭 ─────────────────────────────────┐
│                                            │
│  [추억 카드 - 가로 스크롤]                  │
│  ┌──────┐ ┌──────┐ ┌──────┐               │
│  │3년전  │ │베스트│ │가족  │               │
│  │오늘   │ │사진  │ │여행  │               │
│  └──────┘ └──────┘ └──────┘               │
│                                            │
│  ── 오늘 ──────────────────                │
│  □ □ □ □                                   │
│  □ □ □                                     │
│                                            │
│  ── 어제 ──────────────────                │
│  □ □ □ □                                   │
│  □ □                                       │
│                                            │
│  ── 2026년 2월 8일 ────────                │
│  □ □ □ □                                   │
│                                            │
│  (무한 스크롤...)                           │
│                                            │
│  ┌─ 백업 상태 표시 (하단 떠있는 바) ──────┐ │
│  │  ☁️ 3장 백업 중...  12/15 완료          │ │
│  └────────────────────────────────────────┘ │
└────────────────────────────────────────────┘

사진 탭:
  - 핀치 줌: 그리드 열 수 변경 (3열 ↔ 5열 ↔ 7열)
  - 빠른 스크롤: 우측 날짜 스크롤바 (년/월 점프)
  - 길게 누르기: 다중 선택 모드
  - 상단 떠있는 백업 상태 바
```

#### Tab 2: 검색

```
┌─ 검색 탭 ─────────────────────────────────┐
│                                            │
│  ┌─ 검색창 ───────────────────────────┐    │
│  │  🔍 사진 검색...                    │    │
│  └────────────────────────────────────┘    │
│                                            │
│  ── 인물 ──────────────────────────────    │
│  (●)(●)(●)(●)(●) → 더보기                 │
│  엄마 아빠 나  동생 할머니                  │
│                                            │
│  ── 장소 ──────────────────────────────    │
│  ┌──────┐ ┌──────┐ ┌──────┐               │
│  │ 제주 │ │ 서울 │ │ 부산 │               │
│  └──────┘ └──────┘ └──────┘               │
│                                            │
│  ── 카테고리 ──────────────────────────    │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐     │
│  │음식  │ │풍경  │ │셀피  │ │반려동물│     │
│  └──────┘ └──────┘ └──────┘ └──────┘     │
│                                            │
└────────────────────────────────────────────┘

검색 기능:
  - 텍스트 검색: "엄마", "제주도", "2024년 여름"
  - 인물 탭: 얼굴 클러스터 목록 → 인물별 사진 보기
  - 장소: GPS 기반 자동 그룹핑된 장소 목록
  - 카테고리: AI 분류된 장면/물체 카테고리
```

#### Tab 3: 앨범

```
┌─ 앨범 탭 ─────────────────────────────────┐
│                                            │
│  ── 공유 앨범 ─────────── [+ 새 앨범]      │
│  ┌──────────┐ ┌──────────┐                 │
│  │ 📸       │ │ 📸       │                 │
│  │ 가족여행  │ │ 아기성장  │                 │
│  │ 48장     │ │ 120장    │                 │
│  │ 👨‍👩‍👧‍👦 4명  │ │ 👨‍👩‍👧 3명  │                 │
│  └──────────┘ └──────────┘                 │
│                                            │
│  ── 내 앨범 ──────────────                 │
│  ┌──────────┐ ┌──────────┐                 │
│  │ 📸       │ │ 📸       │                 │
│  │ 즐겨찾기  │ │ 맛집     │                 │
│  │ 23장     │ │ 15장     │                 │
│  └──────────┘ └──────────┘                 │
│                                            │
│  ── 자동 앨범 (AI) ───────                 │
│  ┌──────────┐ ┌──────────┐                 │
│  │ 📸       │ │ 📸       │                 │
│  │ 2024     │ │ 스크린샷  │                 │
│  │ 제주여행  │ │ 89장     │                 │
│  │ 35장     │ │          │                 │
│  └──────────┘ └──────────┘                 │
│                                            │
└────────────────────────────────────────────┘

앨범 기능:
  - 공유 앨범: 가족이 함께 사진을 넣을 수 있는 앨범
  - 내 앨범: 개인 앨범 (나만 보기)
  - 자동 앨범: AI가 이벤트/카테고리별 자동 생성
  - 앨범에 사진 추가: 길게 누르기 → "앨범에 추가"
```

#### Tab 4: 가족

```
┌─ 가족 탭 ─────────────────────────────────┐
│                                            │
│  ── 우리 가족 ──────── [👤 초대하기]       │
│                                            │
│  ┌─ 가족 구성원 ───────────────────────┐   │
│  │ (●) 나 (관리자)     기기 2대 연결    │   │
│  │ (●) 엄마           기기 1대 연결     │   │
│  │ (●) 아빠           기기 1대 연결     │   │
│  │ (●) 동생           오프라인          │   │
│  └────────────────────────────────────┘   │
│                                            │
│  ── 최근 가족 활동 ───────────────────     │
│  │ 📷 엄마가 "가족여행" 앨범에 5장 추가  │   │
│  │ 💬 아빠가 사진에 댓글 남김           │   │
│  │ 📷 동생이 새 사진 12장 백업          │   │
│                                            │
│  ── 가족 통계 ────────────────────────     │
│  │ 📊 전체 사진: 15,234장              │   │
│  │ 💾 저장 공간: 45.2GB / 256GB        │   │
│  │ 👥 가족 구성원: 4명                  │   │
│                                            │
└────────────────────────────────────────────┘

가족 기능:
  - 구성원 목록 + 연결 상태
  - 초대하기 (PIN / QR / 링크)
  - 최근 활동 피드
  - 저장 공간 현황
```

#### Tab 5: TV

```
┌─ TV 탭 ───────────────────────────────────┐
│                                            │
│  ┌─ 연결된 TV ────────────────────────┐    │
│  │ 📺 거실 셋탑       🟢 연결됨       │    │
│  └────────────────────────────────────┘    │
│                                            │
│  ── 슬라이드쇼 시작 ──────────────────     │
│                                            │
│  ┌────────────────────────────────────┐    │
│  │  📁 앨범 선택:  [가족여행 ▼]       │    │
│  │  📅 기간:       [전체 ▼]          │    │
│  │  👤 인물:       [전체 ▼]          │    │
│  │  ⏱️ 간격:       [5초 ▼]           │    │
│  │  🔀 순서:       [랜덤 ▼]          │    │
│  │                                    │    │
│  │      [ ▶️  슬라이드쇼 시작 ]       │    │
│  └────────────────────────────────────┘    │
│                                            │
│  ── 리모컨 모드 (슬라이드쇼 중) ─────      │
│  ┌────────────────────────────────────┐    │
│  │                                    │    │
│  │         [  ◀️  ]  [⏸️]  [  ▶️  ]   │    │
│  │          이전    일시정지   다음     │    │
│  │                                    │    │
│  │         [  ❤️  ]        [  ⏹️  ]   │    │
│  │         좋아요          종료       │    │
│  │                                    │    │
│  └────────────────────────────────────┘    │
│                                            │
└────────────────────────────────────────────┘

TV 기능:
  - 서버(셋탑) TV 출력과 연동
  - 필터 설정 후 슬라이드쇼 시작
  - 리모컨 UI로 재생 제어
  - 현재 표시 중인 사진 정보 표시
```

---

### 2.4 사진 상세 뷰어

```
┌───────────────────────────────────────────┐
│ [←]                           [⋯ 더보기]  │
│                                           │
│                                           │
│                                           │
│              ┌───────────┐                │
│              │           │                │
│              │   사진    │                │
│              │  전체화면  │                │
│              │           │                │
│              │           │                │
│              └───────────┘                │
│         ← 스와이프로 이전/다음 →           │
│              핀치 줌 지원                  │
│                                           │
│───────────────────────────────────────────│
│                                           │
│  2026.02.10 오후 3:42                     │
│  📍 서울특별시 강남구                      │
│  📱 iPhone 15 Pro · f/1.8 · 12MP         │
│  👤 엄마, 아빠                            │
│                                           │
│  ❤️ 좋아요  💬 댓글(2)  📁 앨범추가  📤 공유│
│                                           │
└───────────────────────────────────────────┘

더보기 메뉴 (⋯):
  - 앨범에 추가
  - 다운로드 (원본)
  - 삭제
  - 상세 정보 (EXIF)
```

---

### 2.5 핵심 화면 목록 (전체)

| # | 화면 | 설명 | 우선순위 |
|---|------|------|---------|
| 1 | 온보딩 | 앱 소개 + 서버 찾기 | MVP |
| 2 | 페어링 | PIN 입력 / QR 스캔 | MVP |
| 3 | 계정 생성 | 닉네임 + 비밀번호 설정 | MVP |
| 4 | 사진 탭 (홈) | 타임라인 그리드 + 추억 카드 | MVP |
| 5 | 사진 뷰어 | 전체화면 뷰어 + 메타정보 | MVP |
| 6 | 검색 탭 | 인물/장소/카테고리 검색 | Phase 2 |
| 7 | 앨범 탭 | 공유/개인/자동 앨범 목록 | MVP |
| 8 | 앨범 상세 | 앨범 내 사진 그리드 | MVP |
| 9 | 가족 탭 | 구성원 관리 + 활동 피드 | MVP |
| 10 | TV 탭 | 슬라이드쇼 설정 + 리모컨 | MVP |
| 11 | 설정 | 백업 설정, 계정, 저장소 관리 | MVP |
| 12 | 백업 상태 | 백업 진행률 상세 | MVP |
| 13 | 초대 화면 | QR/PIN/링크 초대 | MVP |

---

### 2.6 앱 기능 정의서 (간결 버전)

#### F1. 자동 백업
```
동작: Wi-Fi 연결 감지 → 새 사진 스캔 → 서버 업로드
상태: 대기 / 백업중 / 완료 / 일시정지
설정: Wi-Fi만 / 충전 중만 / 선택 폴더
표시: 하단 떠있는 진행률 바
```

#### F2. 타임라인 뷰
```
동작: 날짜별 역순으로 사진 썸네일 그리드 표시
조작: 무한 스크롤 / 핀치 줌(열 수 변경) / 날짜 점프 스크롤바
성능: 썸네일 캐시 + 지연 로딩
```

#### F3. 사진 뷰어
```
동작: 전체화면 사진 표시 + 스와이프 탐색
조작: 핀치 줌 / 위로 스와이프(정보) / 더보기 메뉴
정보: 날짜, 위치, 카메라, 인물 태그
액션: 좋아요 / 댓글 / 앨범 추가 / 삭제
```

#### F4. 앨범 관리
```
종류: 공유 앨범 / 개인 앨범 / 자동 앨범(AI)
생성: "+" 버튼 → 이름 입력 → 사진 선택 → 공유 여부 설정
공유: 가족 구성원 선택하여 공유 앨범 생성
```

#### F5. 가족 공유
```
초대: PIN / QR / 링크 3가지 방법
권한: 관리자(모든 권한) / 구성원(자기 사진 + 공유 앨범)
활동: 최근 백업, 앨범 추가, 댓글 등 피드
```

#### F6. TV 리모컨
```
연결: 같은 네트워크 내 서버 자동 감지
조작: 슬라이드쇼 시작/정지/이전/다음
설정: 앨범 선택, 간격, 순서(랜덤/날짜순)
```

---

### 2.7 앱-서버 통신 프로토콜

```
┌──────────────┐                    ┌──────────────┐
│  Flutter App  │                    │ PhotoNest    │
│              │ ── REST API ──────►│ Server       │
│              │◄── JSON 응답 ──────│ (FastAPI)    │
│              │                    │              │
│              │ ── WebSocket ─────►│              │
│              │◄── 실시간 이벤트 ──│              │
│              │   (백업 진행률,     │              │
│              │    TV 리모컨,      │              │
│              │    가족 활동)      │              │
└──────────────┘                    └──────────────┘

REST API: 사진 CRUD, 앨범 관리, 인증 등 일반 작업
WebSocket: 실시간 양방향 통신이 필요한 기능
  - 백업 진행률 실시간 업데이트
  - TV 슬라이드쇼 리모컨 명령
  - 가족 활동 실시간 피드
  - 서버 상태 모니터링
```

---

### 2.8 오프라인 동작

```
네트워크 상태별 앱 동작:

  🟢 서버 연결됨 (홈 Wi-Fi)
     → 모든 기능 정상 작동
     → 자동 백업 실행
     → 실시간 동기화

  🟡 인터넷만 연결 (외부 Wi-Fi/LTE)
     → 로컬 캐시된 썸네일 조회 가능
     → 최근 본 사진 오프라인 조회
     → 백업 대기열에 쌓아둠 (귀가 후 자동 업로드)
     → VPN 연결 시 서버 접근 가능

  🔴 오프라인
     → 캐시된 사진만 조회
     → 새 사진은 백업 대기열에 추가
```

---

*문서 버전: 1.0*
*작성일: 2026-02-10*
*프로젝트: PhotoNest*
