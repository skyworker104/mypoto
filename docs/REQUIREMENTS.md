# PhotoNest - 요구사항 명세서

> 가족을 위한 셀프호스팅 사진 백업 & 조회 시스템
> 안드로이드 셋탑박스를 홈 포토 서버로 활용

---

## 1. 프로젝트 개요

### 1.1 비전
핸드폰(iPhone/Android)의 사진을 **안드로이드 셋탑박스**에 자동 백업하고,
**웹/앱/TV**를 통해 가족이 함께 사진을 감상할 수 있는 **셀프호스팅 시스템**.

### 1.2 핵심 가치
- **프라이버시**: 클라우드 의존 없이 내 사진은 내 집에 보관
- **편의성**: Google Photos 수준의 사용자 경험
- **가족 공유**: 가족 구성원 간 쉬운 사진 공유와 감상
- **TV 연동**: 거실 TV에서 가족 사진 슬라이드쇼 감상

### 1.3 대상 사용자
- 주 사용자: 가족 구성원 (2~6명 예상)
- 관리자: 시스템 설정 및 관리를 담당하는 1인

---

## 2. 시스템 환경

### 2.1 서버 (안드로이드 디바이스)

> 셋탑박스 또는 안드로이드 태블릿을 서버로 활용

#### 옵션 A: 안드로이드 셋탑박스
| 항목 | 사양 |
|------|------|
| OS | Android (셋탑박스) |
| 저장소 | SD 카드 확장 (128GB~1TB) |
| 네트워크 | 가정 내 Wi-Fi / 유선 LAN |
| 출력 | HDMI → TV 연결 |
| 런타임 | Termux 또는 UserLAnd 기반 Linux 환경 |
| 장점 | 상시 전원, TV 직접 연결, 저렴 |

#### 옵션 B: 안드로이드 태블릿
| 항목 | 사양 |
|------|------|
| OS | Android (태블릿) |
| 저장소 | SD 카드 확장 + 내장 스토리지 (64GB~512GB) |
| 네트워크 | Wi-Fi |
| 출력 | 화면 자체 + Miracast/HDMI 어댑터로 TV 연결 가능 |
| 런타임 | Termux 기반 Linux 환경 |
| 장점 | 높은 CPU/RAM 사양, 자체 화면으로 관리 용이, 배터리 내장 (UPS 역할) |
| 주의 | 상시 충전 시 배터리 팽창 위험, TV 연결에 추가 어댑터 필요 |

### 2.2 클라이언트
| 플랫폼 | 기술 | 용도 |
|---------|------|------|
| 모바일 앱 | Flutter (iOS + Android) | 사진 백업 + 조회 + 알림 수신 |
| 웹 브라우저 | Web (반응형) | PC/태블릿에서 조회 + 관리 |
| TV | 셋탑박스 Android 앱 | 슬라이드쇼 + 대화면 감상 |

### 2.3 기술 스택
| 영역 | 기술 |
|------|------|
| 백엔드 API | Python + FastAPI |
| 데이터베이스 | SQLite (경량, 셋탑박스 적합) |
| 파일 저장 | 로컬 파일시스템 (SD 카드) |
| 모바일 앱 | Flutter (Dart) |
| 웹 프론트엔드 | Flutter Web 또는 React (TBD) |
| TV 앱 | Android TV 앱 (Flutter 또는 네이티브) |
| AI (로컬) | ONNX Runtime, MobileFaceNet, CLIP 경량 모델 |
| AI (클라우드) | Google Vision API / OpenAI (고급 기능만) |
| 푸시 알림 | Firebase Cloud Messaging (FCM) |
| 미디어 처리 | Pillow, FFmpeg (썸네일, 변환) |

---

## 3. 기능 요구사항

### 3.1 자동 사진 백업 (FR-BACKUP)

| ID | 요구사항 | 우선순위 |
|----|---------|---------|
| FR-BACKUP-01 | Wi-Fi 연결 시 새로운 사진/동영상을 자동으로 셋탑박스에 업로드 | **필수** |
| FR-BACKUP-02 | 백업 진행 상황을 실시간으로 표시 (진행률, 속도) | **필수** |
| FR-BACKUP-03 | 중복 사진 감지 및 스킵 (해시 기반) | **필수** |
| FR-BACKUP-04 | 백업 실패 시 자동 재시도 (최대 3회) | **필수** |
| FR-BACKUP-05 | 특정 폴더/앨범만 선택적 백업 | 선택 |
| FR-BACKUP-06 | 배터리 충전 중일 때만 백업 옵션 | 선택 |
| FR-BACKUP-07 | HEIC → JPEG 자동 변환 옵션 (iPhone 호환) | **필수** |
| FR-BACKUP-08 | 원본 해상도 유지 + 웹/앱용 리사이즈 썸네일 자동 생성 | **필수** |

#### 사용자 스토리
- **US-BACKUP-01**: 사용자로서, 집에 와서 Wi-Fi에 연결되면 오늘 찍은 사진이 자동으로 백업되길 원한다
- **US-BACKUP-02**: 사용자로서, 이미 백업된 사진을 다시 업로드하지 않아서 시간과 저장공간을 절약하고 싶다

---

### 3.2 사진 조회 및 탐색 (FR-VIEW)

| ID | 요구사항 | 우선순위 |
|----|---------|---------|
| FR-VIEW-01 | 날짜별 타임라인 뷰 (월/일 기준 그룹핑) | **필수** |
| FR-VIEW-02 | 앨범별 조회 (자동 생성 앨범 + 수동 앨범) | **필수** |
| FR-VIEW-03 | 전체화면 사진 뷰어 (스와이프 탐색, 줌) | **필수** |
| FR-VIEW-04 | 동영상 재생 지원 | **필수** |
| FR-VIEW-05 | 사진 검색 (날짜, 위치, 인물, 태그) | **필수** |
| FR-VIEW-06 | 지도 뷰 (GPS 메타데이터 기반 위치별 조회) | 선택 |
| FR-VIEW-07 | 무한 스크롤 + 빠른 썸네일 로딩 (지연 로딩) | **필수** |
| FR-VIEW-08 | 사진 즐겨찾기/좋아요 기능 | 선택 |

#### 사용자 스토리
- **US-VIEW-01**: 사용자로서, 2024년 여름 휴가 때 찍은 사진을 빠르게 찾고 싶다
- **US-VIEW-02**: 사용자로서, 수천 장의 사진을 부드럽게 스크롤하며 탐색하고 싶다

---

### 3.3 AI 사진 정리 (FR-AI)

| ID | 요구사항 | 우선순위 |
|----|---------|---------|
| FR-AI-01 | 얼굴 감지 및 인물별 자동 그룹핑 | **필수** |
| FR-AI-02 | 인물에 이름 태깅 (수동 + 이후 자동 매칭) | **필수** |
| FR-AI-03 | 장소/장면별 자동 분류 (해변, 산, 음식, 건물 등) | **필수** |
| FR-AI-04 | 날짜 + 위치 기반 이벤트 자동 그룹핑 (예: "2024 제주 여행") | 선택 |
| FR-AI-05 | 유사/중복 사진 감지 및 정리 제안 | 선택 |
| FR-AI-06 | 기본 분류는 셋탑박스 로컬에서 처리 (경량 AI 모델) | **필수** |
| FR-AI-07 | 고급 분류(장면 인식 등)는 클라우드 API 선택적 활용 | 선택 |

#### 사용자 스토리
- **US-AI-01**: 사용자로서, "엄마" 라고 검색하면 엄마가 나온 모든 사진을 볼 수 있길 원한다
- **US-AI-02**: 사용자로서, 사진을 올리면 알아서 분류되어 정리된 앨범을 보고 싶다

#### AI 처리 전략 (하이브리드)
```
[로컬 처리 - 셋탑박스]                [클라우드 처리 - 선택적]
├─ 얼굴 감지 (MobileFaceNet)         ├─ 장면 인식 (Google Vision)
├─ 얼굴 임베딩 + 클러스터링           ├─ 텍스트/OCR 인식
├─ EXIF 메타데이터 추출               └─ 고급 이미지 캡셔닝
├─ GPS → 주소 역지오코딩 (캐시)
└─ 기본 이미지 분류 (CLIP 경량)
```

---

### 3.4 TV 슬라이드쇼 (FR-TV)

| ID | 요구사항 | 우선순위 |
|----|---------|---------|
| FR-TV-01 | TV 전체화면 슬라이드쇼 모드 | **필수** |
| FR-TV-02 | 슬라이드쇼 앨범/기간/인물 필터 선택 | **필수** |
| FR-TV-03 | 전환 효과 (페이드, 슬라이드, 줌 등) | 선택 |
| FR-TV-04 | 배경음악 설정 (로컬 음악 파일 재생) | 선택 |
| FR-TV-05 | 핸드폰을 리모컨으로 사용 (재생/정지/다음) | **필수** |
| FR-TV-06 | TV 대기화면으로 사진 자동 표시 (스크린세이버) | 선택 |

#### 사용자 스토리
- **US-TV-01**: 가족으로서, 명절에 TV에서 올해 사진을 슬라이드쇼로 함께 보고 싶다
- **US-TV-02**: 사용자로서, 핸드폰으로 TV 슬라이드쇼를 조작하고 싶다

---

### 3.5 가족 공유 앨범 (FR-FAMILY)

| ID | 요구사항 | 우선순위 |
|----|---------|---------|
| FR-FAMILY-01 | 가족 구성원별 계정 (프로필 + 개별 백업 공간) | **필수** |
| FR-FAMILY-02 | 공유 앨범 생성 및 여러 구성원 사진 모으기 | **필수** |
| FR-FAMILY-03 | 사진에 댓글/이모지 반응 | 선택 |
| FR-FAMILY-04 | 특정 앨범을 특정 가족에게만 공개 (권한 관리) | 선택 |
| FR-FAMILY-05 | 가족 초대 (QR 코드 또는 초대 링크) | **필수** |

#### 사용자 스토리
- **US-FAMILY-01**: 부모로서, 아이 성장 앨범을 가족 모두가 볼 수 있게 공유하고 싶다
- **US-FAMILY-02**: 가족 구성원으로서, 내 사진은 나만 볼 수 있고, 공유한 것만 가족이 보길 원한다

---

### 3.6 추억 알림 / 이벤트 추천 (FR-MEMORY)

| ID | 요구사항 | 우선순위 |
|----|---------|---------|
| FR-MEMORY-01 | "N년 전 오늘" 추억 사진 푸시 알림 | **필수** |
| FR-MEMORY-02 | 주간/월간 베스트 사진 랜덤 추천 | **필수** |
| FR-MEMORY-03 | 특별한 날 (생일, 기념일) 사진 모음 알림 | 선택 |
| FR-MEMORY-04 | AI 기반 "하이라이트 영상" 자동 생성 | 후속 개발 |
| FR-MEMORY-05 | 알림 빈도 및 시간대 설정 가능 | **필수** |

#### 사용자 스토리
- **US-MEMORY-01**: 사용자로서, 3년 전 가족 여행 사진을 랜덤으로 받아서 추억을 떠올리고 싶다
- **US-MEMORY-02**: 사용자로서, 너무 자주 오는 알림은 피곤하므로 빈도를 조절하고 싶다

---

### 3.7 음성 비서 - Nesty (FR-VOICE)

| ID | 요구사항 | 우선순위 |
|----|---------|---------|
| FR-VOICE-01 | 호출명("야 네스티")으로 음성 비서 활성화 (다이렉트 모드) | Phase 2 |
| FR-VOICE-02 | 폰 앱에서 음성 명령 버튼으로 서버에 명령 전송 (리모트 모드) | **필수** |
| FR-VOICE-03 | 음성으로 사진 검색 (인물/장소/날짜) | **필수** |
| FR-VOICE-04 | 음성으로 슬라이드쇼 시작/제어 | **필수** |
| FR-VOICE-05 | 서버 화면에 대화 내역 + 결과 실시간 표시 | **필수** |
| FR-VOICE-06 | 멀티턴 대화 (문맥 유지) | Phase 2 |
| FR-VOICE-07 | 호출명 커스터마이징 | Phase 2 |
| FR-VOICE-08 | TTS 음성 응답 | Phase 2 |

#### 사용자 스토리
- **US-VOICE-01**: 사용자로서, "야 네스티, 지난 여름 가족사진 보여줘" 라고 말하면 TV에 사진이 나오길 원한다
- **US-VOICE-02**: 사용자로서, 서버에 마이크가 없어도 폰 앱으로 음성 명령을 할 수 있길 원한다

> 상세 설계: [DESIGN_VOICE_ASSISTANT.md](./DESIGN_VOICE_ASSISTANT.md) 참조

---

## 4. 비기능 요구사항

### 4.1 성능 (NFR-PERF)
| ID | 요구사항 | 기준 |
|----|---------|------|
| NFR-PERF-01 | 썸네일 로딩 | 100장 기준 2초 이내 |
| NFR-PERF-02 | 원본 사진 로딩 | 3초 이내 |
| NFR-PERF-03 | 검색 응답 | 1초 이내 (10만 장 기준) |
| NFR-PERF-04 | 백업 속도 | Wi-Fi 환경에서 10MB/s 이상 |
| NFR-PERF-05 | AI 처리 | 사진 1장당 로컬 얼굴 감지 5초 이내 |

### 4.2 저장 및 용량 (NFR-STORAGE)
| ID | 요구사항 | 기준 |
|----|---------|------|
| NFR-STORAGE-01 | 저장 용량 모니터링 | SD 카드 사용량 대시보드 |
| NFR-STORAGE-02 | 썸네일 캐시 | 원본 대비 10% 이하 용량 |
| NFR-STORAGE-03 | DB 크기 | 10만 장 기준 500MB 이내 |

### 4.3 보안 (NFR-SEC)
| ID | 요구사항 | 기준 |
|----|---------|------|
| NFR-SEC-01 | 사용자 인증 | JWT 기반 토큰 인증 |
| NFR-SEC-02 | 전송 암호화 | HTTPS (self-signed 허용) |
| NFR-SEC-03 | 가정 외부 접근 | VPN 또는 Tailscale 권장 |

### 4.4 안정성 (NFR-REL)
| ID | 요구사항 | 기준 |
|----|---------|------|
| NFR-REL-01 | 서버 자동 시작 | 셋탑박스 부팅 시 서비스 자동 시작 |
| NFR-REL-02 | 업로드 중단 복구 | 중단된 업로드 이어받기 지원 |
| NFR-REL-03 | DB 백업 | SQLite DB 주기적 자동 백업 |

---

## 5. 수용 기준 (Acceptance Criteria)

### MVP (최소 실행 가능 제품)
- [ ] 핸드폰에서 Wi-Fi로 사진을 셋탑박스에 업로드할 수 있다
- [ ] 업로드된 사진을 웹/앱에서 타임라인으로 볼 수 있다
- [ ] 가족 구성원이 각자 계정으로 로그인할 수 있다
- [ ] 공유 앨범을 만들어 가족과 사진을 공유할 수 있다
- [ ] TV에서 사진 슬라이드쇼를 볼 수 있다

### Phase 2
- [ ] AI 얼굴 인식으로 인물별 앨범이 자동 생성된다
- [ ] 날짜/위치 기반 검색이 작동한다
- [ ] "N년 전 오늘" 추억 알림이 핸드폰으로 온다

### Phase 3
- [ ] AI 장면 분류가 작동한다 (하이브리드)
- [ ] 지도 뷰에서 위치별 사진을 볼 수 있다
- [ ] 하이라이트 영상 자동 생성

---

## 6. 제약 사항 및 리스크

### 제약 사항
| 항목 | 내용 |
|------|------|
| 셋탑박스 성능 | ARM 프로세서 + 제한된 RAM, 무거운 AI 모델 실행 어려움 |
| SD 카드 수명 | 빈번한 쓰기 작업으로 SD 카드 수명 단축 가능 |
| 네트워크 | 가정 내 네트워크에서만 기본 접근 가능 |
| Termux 제한 | 안드로이드 보안 정책에 따라 일부 기능 제한 가능 |

### 리스크 및 대응
| 리스크 | 영향 | 대응 방안 |
|--------|------|----------|
| 셋탑박스에서 Python/FastAPI 성능 부족 | 느린 응답 | Go 또는 Rust로 핵심 모듈 대체 검토 |
| SD 카드 고장으로 데이터 손실 | 치명적 | 주기적 외부 백업, RAID 미러링 불가하므로 클라우드 2차 백업 옵션 |
| AI 로컬 처리가 너무 느림 | UX 저하 | 백그라운드 큐 처리, 야간 배치 처리 적용 |
| 가정 외부에서 접근 필요 | 기능 제한 | Tailscale/WireGuard VPN 연동 |

---

## 7. 용어 정의

| 용어 | 설명 |
|------|------|
| 셋탑박스 | Android OS 기반의 TV 연결 장치, 본 프로젝트에서 서버 역할 |
| PhotoNest 서버 | 셋탑박스에서 실행되는 FastAPI 기반 백엔드 서비스 |
| 타임라인 뷰 | 날짜순으로 사진을 나열하는 메인 조회 화면 |
| 추억 알림 | 과거 사진을 랜덤/이벤트 기반으로 푸시 알림하는 기능 |
| 하이브리드 AI | 기본은 로컬 처리, 고급 기능은 클라우드 API를 선택적으로 활용 |

---

## 8. 다음 단계

이 요구사항이 확정되면 다음 순서로 진행합니다:

1. ~~**`/sc:design`** → 시스템 아키텍처 설계~~ ✅ 완료
2. ~~**`/sc:workflow`** → 단계별 구현 계획 생성~~ ✅ 완료
3. **`/sc:implement`** → MVP부터 순차적 구현

### 설계 문서 목록
- [시스템 아키텍처](./DESIGN_ARCHITECTURE.md) - 전체 구조, DB 스키마, API 명세, 프로젝트 구조, 배포
- [페어링 & 앱 설계](./DESIGN_PAIRING_AND_APP.md) - 서버-폰 페어링, 모바일 앱 UI/기능
- [음성 비서 설계](./DESIGN_VOICE_ASSISTANT.md) - Nesty 아키텍처, 명령어, 서버 화면
- [구현 워크플로우](./WORKFLOW_IMPLEMENTATION.md) - Sprint별 구현 계획, 의존성, 체크포인트

---

## 9. 기술 타당성 검토 결과

### 9.1 셋탑박스 서버 (Termux + FastAPI)

| 항목 | 상태 | 비고 |
|------|------|------|
| Python 3.10+ / FastAPI | ✅ 가능 | Termux에서 정상 작동 확인 |
| SQLite | ✅ 가능 | WAL 모드 + 인덱스 최적화 필요 |
| TensorFlow Lite (얼굴 감지) | ✅ 가능 | 경량 모델 사용 시 실행 가능 |
| 부팅 시 자동 시작 | ✅ 가능 | Termux:Boot 애드온 사용 |
| SD 카드 쓰기 | ⚠️ 제한적 | **루팅 또는 ADB 권한 필요**, 기본은 읽기 전용 |
| CLIP 모델 (장면 분류) | ⚠️ 주의 | 일반 셋탑(A53 CPU)에서는 너무 느림, 클라우드 위임 권장 |
| Android 11+ 저장 성능 | ⚠️ 주의 | Scoped Storage로 10배 성능 저하 가능 |

#### 핵심 대응 방안
1. **SD 카드 문제**: 셋탑박스를 루팅하거나, ADB로 쓰기 권한 부여 필요
2. **AI 처리**: TFLite 경량 모델(얼굴 감지)만 로컬, 장면 분류는 클라우드 API
3. **권장 하드웨어**:
   - **셋탑박스**: RK3588 기반 (4-8GB RAM, NPU 내장) 적극 권장
   - **태블릿**: Snapdragon 600+급 또는 MediaTek Helio G9x 이상 (4GB+ RAM) 권장. 중고 태블릿 활용 시 가성비 우수
4. **Android 버전**: 가능하면 Android 10 탑재 기기 선택, 11+는 스토리지 성능 테스트 필수

### 9.2 Flutter 모바일 앱

| 항목 | 상태 | 추천 패키지 |
|------|------|------------|
| 사진 라이브러리 접근 | ✅ 가능 | `photo_manager` |
| 백그라운드 업로드 (Android) | ✅ 가능 | `workmanager` |
| 백그라운드 업로드 (iOS) | ⚠️ 제한적 | 30초 실행 제한, 시스템 제어 |
| 새 사진 자동 감지 | ✅ 가능 | `photo_manager` observer |
| HEIC 변환 | ✅ 가능 | `heif_converter` |
| 푸시 알림 (FCM) | ✅ 가능 | `firebase_messaging` |
| Android TV 리모컨 | ✅ 가능 | `androidtvremote` 또는 MQTT |
| Wi-Fi 감지 | ✅ 가능 | `connectivity_plus` |

#### 핵심 대응 방안
1. **iOS 백그라운드 제한**: "앱 열었을 때 동기화" + Background Fetch 병행 전략
2. **HEIC 처리**: 서버 측 변환 권장 (모바일 배터리 절약)
3. **TV 앱**: 셋탑박스에 별도 TV 컴패니언 앱 필요 (Flutter로 개발 가능)

### 9.3 종합 판정

| 영역 | 판정 | 핵심 리스크 |
|------|------|------------|
| 백엔드 서버 | **실현 가능** | SD 카드 쓰기 권한, 하드웨어 성능 |
| 모바일 앱 | **실현 가능** | iOS 백그라운드 업로드 제한 |
| AI 기능 | **부분 가능** | 로컬은 얼굴 감지만, 나머지는 클라우드 |
| TV 슬라이드쇼 | **실현 가능** | 별도 컴패니언 앱 개발 필요 |

> **결론**: 전체적으로 **실현 가능한 프로젝트**이나, 셋탑박스 루팅/ADB 설정과
> RK3588급 하드웨어 확보가 원활한 개발의 전제 조건입니다.

---

*문서 버전: 1.0*
*작성일: 2026-02-10*
*프로젝트: PhotoNest*
